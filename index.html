<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Häng med App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Nunito Sans', sans-serif;
            color: #2E2E2E;
        }
        .animate-fade-in-out {
            animation: fadeInOut 3s ease-in-out;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px) translateX(-50%); }
            10% { opacity: 1; transform: translateY(0) translateX(-50%); }
            90% { opacity: 1; transform: translateY(0) translateX(-50%); }
            100% { opacity: 0; transform: translateY(20px) translateX(-50%); }
        }
        /* Fix for iOS date/time input background color */
        input[type="date"], input[type="time"] {
            -webkit-appearance: none;
        }
        /* Hide scrollbar for filter bar */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
    </style>
</head>
<body class="bg-white">
    <div id="root"></div>

    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        // --- CONSTANTS & HELPER DATA (Moved outside component for efficiency) ---
        const { useState, useEffect, useRef, memo, useMemo } = React;

        const USERS_DATA = [
            { userID: 1, name: 'Sofia', email: 'sofia@example.com' },
            { userID: 2, name: 'Erik', email: 'erik@example.com' },
            { userID: 5, name: 'Filip', email: 'filip@example.com' }
        ];

        const INITIAL_EVENTS_DATA = [
            { eventID: 101, title: 'Morgonfika på Vete-Katten', description: 'En klassisk svensk fika för att starta dagen.', category: 'Fika', location: 'Järntorget 3, Göteborg', dateTime: '2025-09-20T10:00:00', creatorUserID: 2, attendeeUserIDs: [2, 5] },
            { eventID: 102, title: 'Avkopplande promenad i Slottsskogen', description: 'En fridfull promenad i vacker natur.', category: 'Promenad', location: 'Säldammsbacken, Göteborg', dateTime: '2025-09-21T14:30:00', creatorUserID: 1, attendeeUserIDs: [1, 5] },
            { eventID: 103, title: 'Badminton i Fjäderborgen', description: 'Vänskapsmatch i badminton, alla nivåer välkomna.', category: 'Sport', location: 'Södra Långebergsgatan 4, Göteborg', dateTime: '2025-09-22T18:00:00', creatorUserID: 1, attendeeUserIDs: [1] },
        ];

        const INITIAL_CHAT_MESSAGES_DATA = {
            101: [{ messageID: 1, userID: 2, text: "Ska bli så mysigt! Jag är där prick kl 10.", timestamp: "2025-09-20T09:30:00" }, { messageID: 2, userID: 5, text: "Absolut, jag ser fram emot det!", timestamp: "2025-09-20T09:32:00" }],
            102: [{ messageID: 3, userID: 1, text: "Vilket härligt väder det ser ut att bli!", timestamp: "2025-09-21T10:00:00" }]
        };

        const CATEGORY_MAP = {
            'Mat & Dryck': ['Fika', 'Äta ute', 'Ta ett glas'],
            'Aktivitet & Natur': ['Promenad', 'Träna tillsammans', 'Sport'],
            'Kultur & Nöje': ['Bio', 'Museum / Utställning', 'Konsert / Gig'],
            'Hobby & Spel': ['Brädspel / Spelkväll', 'Fotografering'],
            'Annat': ['Annat']
        };

        // --- UTILITY FUNCTIONS ---
        const formatDateTime = (isoString) => {
            if (!isoString) return '';
            const date = new Date(isoString);
            const options = { weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false };
            return date.toLocaleDateString('sv-SE', options);
        };
        
        const combineDateAndTime = (date, time) => {
            if (!date || !time) return null;
            return `${date}T${time}:00`;
        }

        // --- ICON COMPONENTS ---
        const Icons = {
            search: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" x2="16.65" y1="21" y2="16.65"></line></svg>),
            home: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>),
            calendar: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect><line x1="16" x2="16" y1="2" y2="6"></line><line x1="8" x2="8" y1="2" y2="6"></line><line x1="3" x2="21" y1="10" y2="10"></line></svg>),
            user: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>),
            plus: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" x2="12" y1="5" y2="19"></line><line x1="5" x2="19" y1="12" y2="12"></line></svg>),
            arrowLeft: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>),
            logOut: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" x2="9" y1="12" y2="12"></line></svg>),
            users: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>),
            mapPin: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>),
            clock: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>),
            send: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>),
            messageCircle: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>),
            settings: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>),
            chevronRight: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>),
            edit: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>),
            trash: (props) => (<svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>),
        };
        
        // --- REUSABLE UI COMPONENTS (Memoized for performance) ---
        const ActionButton = memo(({ onClick, children, className = '', type = "button" }) => (
            <button
                type={type}
                onClick={onClick}
                className={`w-full text-white font-bold py-3 px-4 rounded-full bg-[#C3B37A] hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#C3B37A] transition-all duration-300 shadow-sm ${className}`}
            >
                {children}
            </button>
        ));

        const SwipeButton = ({ onSuccess, text }) => {
            const [thumbPosition, setThumbPosition] = useState(0);
            const [isSwiping, setIsSwiping] = useState(false);
            const [isCompleted, setIsCompleted] = useState(false);
            const trackRef = useRef(null);
            const thumbRef = useRef(null);
            
            const handleSwipeStart = (e) => {
                if (isCompleted) return;
                setIsSwiping(true);
                thumbRef.current.style.transition = 'none';
                document.addEventListener('mousemove', handleSwipeMove);
                document.addEventListener('touchmove', handleSwipeMove, { passive: false });
                document.addEventListener('mouseup', handleSwipeEnd);
                document.addEventListener('touchend', handleSwipeEnd);
            };

            const handleSwipeMove = (e) => {
                e.preventDefault();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const trackRect = trackRef.current.getBoundingClientRect();
                const thumbWidth = thumbRef.current.offsetWidth;
                let newX = clientX - trackRect.left - (thumbWidth / 2);
                const maxPosition = trackRect.width - thumbWidth;
                newX = Math.max(0, Math.min(newX, maxPosition));
                setThumbPosition(newX);
            };

            const handleSwipeEnd = () => {
                document.removeEventListener('mousemove', handleSwipeMove);
                document.removeEventListener('touchmove', handleSwipeMove);
                document.removeEventListener('mouseup', handleSwipeEnd);
                document.removeEventListener('touchend', handleSwipeEnd);

                if (!isSwiping) return;

                setIsSwiping(false);
                thumbRef.current.style.transition = 'transform 0.3s ease-out';
                const trackWidth = trackRef.current.offsetWidth;
                const thumbWidth = thumbRef.current.offsetWidth;
                const successThreshold = trackWidth - thumbWidth - 5;

                if (thumbPosition >= successThreshold) {
                    setThumbPosition(trackWidth - thumbWidth);
                    setIsCompleted(true);
                    onSuccess();
                } else {
                    setThumbPosition(0);
                }
            };

            return (
                <div ref={trackRef} className="w-full h-[52px] bg-green-200 rounded-full relative flex items-center justify-center overflow-hidden select-none cursor-grab active:cursor-grabbing">
                    <span className={`z-10 text-green-800 font-bold transition-opacity duration-300 ${isSwiping || isCompleted ? 'opacity-0' : 'opacity-100'}`}>
                        {text}
                    </span>
                    <div 
                        ref={thumbRef}
                        className="w-[52px] h-[52px] bg-green-500 rounded-full absolute top-0 left-0 flex items-center justify-center shadow-md border-4 border-green-200"
                        style={{ transform: `translateX(${thumbPosition}px)` }}
                        onMouseDown={handleSwipeStart}
                        onTouchStart={handleSwipeStart}
                    >
                        <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path></svg>
                    </div>
                </div>
            );
        };


        const BottomNav = memo(({ activeView, onNavigate }) => {
            const navItems = [
                { view: 'home', icon: Icons.home, label: 'Träffar' },
                { view: 'my-events', icon: Icons.calendar, label: 'Mina träffar' },
                { view: 'chat', icon: Icons.messageCircle, label: 'Chattar' },
                { view: 'profile', icon: Icons.user, label: 'Profil' }
            ];
            return (
                <div className="flex justify-around items-center p-2 bg-white/80 backdrop-blur-sm border-t border-slate-200/50 mt-auto">
                    {navItems.map(item => {
                        const isActive = activeView === item.view;
                        return (
                            <button
                                key={item.view}
                                onClick={() => onNavigate(item.view)}
                                className={`flex flex-col items-center gap-1 p-2 rounded-lg transition-colors duration-200 relative ${isActive ? 'text-[#C3B37A]' : 'text-slate-400 hover:text-[#C3B37A]'}`}
                            >
                                <item.icon className="w-6 h-6" />
                                <span className="text-xs font-bold">{item.label}</span>
                                {isActive && <div className="absolute -bottom-1 h-1 w-1 bg-[#C3B37A] rounded-full"></div>}
                            </button>
                        );
                    })}
                </div>
            );
        });

        const LoginScreen = memo(({ users, onLogin, onNavigate }) => {
            const [selectedUserId, setSelectedUserId] = useState(users[0]?.userID || '');
            const handleLogin = (e) => {
                e.preventDefault();
                const user = users.find(u => u.userID === parseInt(selectedUserId));
                if (user) onLogin(user);
            };
            return (
                <div className="h-full flex flex-col justify-center items-center p-8 bg-white">
                    <h1 className="text-5xl font-bold mb-4 text-[#C3B37A]">Häng med</h1>
                    <p className="text-[#2E2E2E] mb-8 text-center">Upptäck och skapa trevliga träffar nära dig.</p>
                    <form onSubmit={handleLogin} className="w-full max-w-xs space-y-4">
                        <select value={selectedUserId} onChange={(e) => setSelectedUserId(e.target.value)} className="w-full px-4 py-3 border border-slate-200/80 rounded-full focus:outline-none focus:ring-2 focus:ring-[#C3B37A] bg-white">
                            {users.map(user => <option key={user.userID} value={user.userID}>{user.name}</option>)}
                        </select>
                        <ActionButton type="submit">Logga in</ActionButton>
                    </form>
                    <button onClick={() => onNavigate('signup')} className="text-sm text-[#2E2E2E] mt-4 hover:underline">Inget konto? Skapa ett</button>
                    <p className="text-xs text-slate-500 mt-8 text-center max-w-xs mx-auto">
                        Ett tips för en trygg träff: Välj en offentlig plats när ni ses för första gången och använd sunt förnuft. Ha så kul!
                    </p>
                </div>
            );
        });

        const SignUpScreen = memo(({ onSignUp, onNavigate }) => {
            const [name, setName] = useState('');
            const [email, setEmail] = useState('');
            const handleSignUp = (e) => {
                e.preventDefault();
                if (name.trim() && email.trim()) onSignUp({ name, email });
            };
            return (
                <div className="h-full flex flex-col justify-center items-center p-8 bg-white">
                    <h1 className="text-4xl font-bold mb-4 text-[#C3B37A]">Gå med oss</h1>
                    <p className="text-[#2E2E2E] mb-8 text-center">Skapa ditt konto för att börja.</p>
                    <form onSubmit={handleSignUp} className="w-full max-w-xs space-y-4">
                        <div><input type="text" placeholder="Ditt namn" value={name} onChange={e => setName(e.target.value)} required className="w-full px-4 py-3 border border-slate-200/80 rounded-full focus:outline-none focus:ring-2 focus:ring-[#C3B37A] bg-white" /></div>
                        <div><input type="email" placeholder="Din e-post" value={email} onChange={e => setEmail(e.target.value)} required className="w-full px-4 py-3 border border-slate-200/80 rounded-full focus:outline-none focus:ring-2 focus:ring-[#C3B37A] bg-white" /></div>
                        <div><input type="password" placeholder="Lösenord" required className="w-full px-4 py-3 border border-slate-200/80 rounded-full focus:outline-none focus:ring-2 focus:ring-[#C3B37A] bg-white" /></div>
                        <ActionButton type="submit">Skapa konto</ActionButton>
                    </form>
                    <button onClick={() => onNavigate('login')} className="text-sm text-[#2E2E2E] mt-4 hover:underline">Har du redan ett konto? Logga in</button>
                </div>
            );
        });

        const HomeScreen = memo(({ events, onNavigate, currentUser }) => {
            const [activeFilter, setActiveFilter] = useState('Alla');
            const filters = ['Alla', ...Object.keys(CATEGORY_MAP)];

            const filteredEvents = useMemo(() => {
                const sortedEvents = [...events].sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));
                if (activeFilter === 'Alla') {
                    return sortedEvents;
                }
                const subCategories = CATEGORY_MAP[activeFilter];
                return sortedEvents.filter(event => subCategories.includes(event.category));
            }, [events, activeFilter]);
            
            return (
                <div className="flex flex-col h-full bg-white">
                    <header className="p-6 pb-2 border-b border-slate-200/50 bg-white/80 backdrop-blur-sm sticky top-0 z-10">
                        <h1 className="text-3xl font-bold text-[#C3B37A]">Träffar</h1>
                        <p className="text-[#2E2E2E] mt-1">Hej {currentUser.name}, hitta eller skapa något att göra!</p>
                    </header>
                    <div className="px-6 py-3 border-b border-slate-200/50 sticky top-[98px] bg-white/80 backdrop-blur-sm z-10">
                        <div className="flex space-x-2 overflow-x-auto pb-2 no-scrollbar">
                            {filters.map(filter => (
                                <button
                                    key={filter}
                                    onClick={() => setActiveFilter(prevFilter => prevFilter === filter ? 'Alla' : filter)}
                                    className={`px-4 py-2 rounded-full text-sm font-semibold whitespace-nowrap transition-colors ${activeFilter === filter ? 'bg-[#C3B37A] text-white shadow-sm' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}
                                >
                                    {filter}
                                </button>
                            ))}
                        </div>
                    </div>
                    <main className="flex-grow overflow-y-auto p-6 space-y-4">
                        {filteredEvents.map(event => {
                            const isJoined = event.attendeeUserIDs.includes(currentUser.userID);
                            const isCreator = event.creatorUserID === currentUser.userID;
                            const borderColor = isCreator ? 'border-blue-400' : isJoined ? 'border-green-500' : 'border-[#5C524F]';
                            return (
                                <div key={event.eventID} onClick={() => onNavigate('details', event.eventID)} className={`p-4 rounded-xl shadow-sm cursor-pointer transition-all bg-white hover:shadow-md relative border-[1mm] ${borderColor}`}>
                                    <div className="flex items-start gap-4">
                                        <div className="flex-1 min-w-0">
                                            <p className="font-bold text-[#2E2E2E] truncate">{event.title}</p>
                                            <p className="text-sm text-[#2E2E2E]">{event.category}</p>
                                            <div className="text-xs text-[#2E2E2E]/80 mt-2 flex items-center gap-2">
                                                <Icons.clock className="w-3 h-3" />
                                                <span className="font-bold">{formatDateTime(event.dateTime)}</span>
                                            </div>
                                            <div className="text-xs text-[#2E2E2E]/80 mt-1 flex items-center gap-2">
                                                <Icons.mapPin className="w-3 h-3" />
                                                <span className="truncate">{event.location}</span>
                                            </div>
                                        </div>
                                        <div className="flex items-center text-sm text-blue-600 font-semibold">
                                            <Icons.users className="w-4 h-4 mr-1" />
                                            <span>{event.attendeeUserIDs.length}</span>
                                        </div>
                                    </div>
                                    
                                </div>
                            )
                        })}
                    </main>
                </div>
            );
        });
        
        const ChatComponent = memo(({ eventId, messages, usersById, currentUser, onSendMessage, hasJoined, isCreator }) => {
            const [newMessage, setNewMessage] = useState('');
            const chatContainerRef = useRef(null);
            
            const borderColor = isCreator ? 'border-blue-400' : hasJoined ? 'border-green-500' : 'border-[#5C524F]';

            useEffect(() => {
                if (chatContainerRef.current) {
                    chatContainerRef.current.scrollTop = chatContainerRef.current.scrollHeight;
                }
            }, [messages]);

            const handleSend = (e) => {
                e.preventDefault();
                if (newMessage.trim()) {
                    onSendMessage(eventId, newMessage);
                    setNewMessage('');
                }
            };
            return (
                <div className={`bg-white p-5 rounded-xl border-[1mm] ${borderColor}`}>
                    <div ref={chatContainerRef} className="space-y-4 max-h-48 overflow-y-auto pr-2">
                        {messages.map(message => {
                            const sender = usersById[message.userID];
                            const isCurrentUser = sender.userID === currentUser.userID;
                            return (
                                <div key={message.messageID} className={`flex items-end gap-2 ${isCurrentUser ? 'justify-end' : ''}`}>
                                    {!isCurrentUser && (
                                        <div className="w-8 h-8 rounded-full bg-[#F5F5DC] flex items-center justify-center font-bold text-[#2E2E2E]/70 text-sm flex-shrink-0">
                                            {sender.name.charAt(0)}
                                        </div>
                                    )}
                                    <div className={`max-w-xs p-3 rounded-2xl ${isCurrentUser ? 'bg-[#C3B37A] text-white rounded-br-none' : 'bg-green-100 text-green-900 rounded-bl-none'}`}>
                                        <p className="text-sm">{message.text}</p>
                                    </div>
                                </div>
                            );
                        })}
                        {messages.length === 0 && <p className="text-sm text-slate-400 text-center py-4">Inga meddelanden än. Bli den första att skriva!</p>}
                    </div>
                     <form onSubmit={handleSend} className="mt-4 flex items-center gap-2">
                        <input 
                            type="text" 
                            value={newMessage}
                            onChange={(e) => setNewMessage(e.target.value)}
                            placeholder="Skriv ett meddelande..."
                            className="w-full p-2 border border-slate-200/80 rounded-full focus:outline-none focus:ring-2 focus:ring-[#C3B37A] bg-white"
                        />
                        <button type="submit" className="p-2.5 rounded-full bg-[#C3B37A] text-white hover:opacity-90 transition-opacity">
                            <Icons.send className="w-5 h-5" />
                        </button>
                    </form>
                </div>
            );
        });
        
        const EventDetailsScreen = memo(({ eventId, events, usersById, currentUser, onJoin, onLeave, onNavigate, chatMessages, onSendMessage }) => {
            const event = events.find(e => e.eventID === eventId);
            if (!event) return <div className="p-4">Träffen hittades inte.</div>;
            
            const creator = usersById[event.creatorUserID];
            const attendees = event.attendeeUserIDs.map(id => usersById[id]);
            const hasJoined = event.attendeeUserIDs.includes(currentUser.userID);
            const isCreator = currentUser.userID === event.creatorUserID;
            const borderColor = isCreator ? 'border-blue-400' : hasJoined ? 'border-green-500' : 'border-[#5C524F]';
            
            return (
                <div className="flex flex-col h-full bg-white">
                    <header className="p-4 flex items-center justify-between border-b border-slate-200/50 bg-white/50 backdrop-blur-sm">
                        <button onClick={() => onNavigate('home')} className="p-2 rounded-full hover:bg-slate-100/60">
                            <Icons.arrowLeft className="w-6 h-6 text-[#2E2E2E]" />
                        </button>
                        <div className="flex-1"></div> {/* Spacer */}
                        
                    </header>
                    <main className="flex-grow overflow-y-auto p-6 space-y-6">
                        <div className={`bg-white p-5 rounded-xl space-y-4 border-[1mm] ${borderColor}`}>
                            <div className="flex items-center gap-4">
                                <div className="min-w-0"><h2 className="text-2xl font-bold text-[#2E2E2E] break-words">{event.title}</h2></div>
                            </div>
                            <p className="text-[#2E2E2E]/80 break-words">{event.description}</p>
                            <div className="space-y-3 pt-2 text-[#2E2E2E]">
                                <div className="flex items-center gap-3"><Icons.clock className="w-5 h-5 text-[#2E2E2E]/60" /><span>{formatDateTime(event.dateTime)}</span></div>
                                <div className="flex items-center gap-3"><Icons.mapPin className="w-5 h-5 text-[#2E2E2E]/60" /><span className="break-words min-w-0">{event.location}</span></div>
                                <div className="flex items-center gap-3"><Icons.user className="w-5 h-5 text-[#2E2E2E]/60" /><span>Skapad av <strong>{creator?.name || 'Okänd'}</strong></span></div>
                            </div>
                            <div>
                                <h3 className="font-semibold mb-2 text-[#2E2E2E]">Vem kommer? ({attendees.length})</h3>
                                <div className="flex flex-wrap gap-2">
                                    {attendees.map(attendee => attendee && (
                                        <div key={attendee.userID} className={`flex items-center gap-2 pr-3 py-1 bg-slate-100 text-[#2E2E2E] rounded-full text-sm ${attendee.userID === currentUser.userID ? 'ring-2 ring-[#C3B37A]' : ''}`}>
                                            <div className="w-6 h-6 rounded-full bg-[#F5F5DC] flex items-center justify-center font-bold text-[#2E2E2E]/70 text-xs">
                                                {attendee.name.charAt(0)}
                                            </div>
                                            {attendee.name}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                        {hasJoined ? (
                            <ChatComponent eventId={eventId} messages={chatMessages[eventId] || []} usersById={usersById} currentUser={currentUser} onSendMessage={onSendMessage} hasJoined={hasJoined} isCreator={isCreator} />
                        ) : (
                            <div className="bg-white p-8 rounded-xl shadow-sm text-center border-[1mm] border-[#5C524F]">
                                <p className="font-semibold text-[#2E2E2E]">Gå med för att se chatten</p>
                                <p className="text-sm text-[#2E2E2E]/70 mt-1">Prata med andra deltagare genom att anmäla dig till träffen.</p>
                            </div>
                        )}
                    </main>
                    <footer className="p-4 bg-white/80 backdrop-blur-sm border-t border-slate-200/50">
                        {isCreator && (
                            <ActionButton onClick={() => onNavigate('edit-event', event.eventID)} className="mb-2">
                                Gör ändringar i träff
                            </ActionButton>
                        )}
                        {hasJoined ? (
                            <button onClick={() => onLeave(event.eventID)} className="w-full text-red-700 font-semibold py-3 px-4 rounded-full bg-red-100 hover:bg-red-200 transition-all duration-300 shadow-sm">
                                Gå ut från träff
                            </button>
                        ) : (
                             <SwipeButton onSuccess={() => onJoin(event.eventID)} text="Svep för att gå med" />
                        )}
                    </footer>
                </div>
            );
        });

        const CreateEventScreen = memo(({ currentUser, onCreate, onNavigate }) => {
            const [title, setTitle] = useState('');
            const [category, setCategory] = useState('Fika');
            const [location, setLocation] = useState('');
            const [date, setDate] = useState('');
            const [time, setTime] = useState('');
            const [description, setDescription] = useState('');
            const [isGenerating, setIsGenerating] = useState(false);
            const today = new Date().toISOString().split('T')[0];
            
            const generateAIDescription = () => {
                setIsGenerating(true);
                setTimeout(() => {
                    const templates = {
                        'Fika': [`En trevlig fika för att snacka och umgås. Vi ses vid ${location || 'angiven plats'} runt ${time || 'utsatt tid'} för lite kaffe och gott sällskap.`, `Dags för en kaffepaus! Jag bjuder in till en avslappnad fika på ${location || 'trevligt ställe'} vid ${time || 'passande tid'}. Hoppas vi ses!`],
                        'Äta ute': [`Gemensam middag på ${location || 'restaurangen'}. En kväll med god mat och härligt sällskap. Bokat bord från kl ${time || 'utsatt tid'}.`, `Lunchdejt! Vi käkar på ${location || 'stället'} runt ${time || 'lunchtid'}. Ett perfekt avbrott i dagen.`],
                        'Ta ett glas': [`Sugen på en öl eller ett glas vin? Vi ses på ${location || 'ett trevligt ställe'} för en avslappnad after-work eller helgkväll runt ${time || 'utsatt tid'}.`],
                        'Promenad': [`Häng med på en uppfriskande promenad vid ${location || 'vårt mötesställe'}. Vi tar en skön tur och njuter av omgivningen, startar runt ${time || 'utsatt tid'}.`],
                        'Träna tillsammans': [`Dags att röra på sig! En löprunda, ett pass på utegymmet eller något annat? Vi ses vid ${location || 'platsen'} runt ${time || 'utsatt tid'} för att träna tillsammans.`],
                        'Sport': [`Dags för sport! ${title || 'En rolig sportaktivitet'} vid ${location || 'platsen'}. Perfekt för att få upp pulsen och ha kul tillsammans. Starttid är ${time || 'ca tid'}.`, `Ska vi se matchen på ${location || 'en sportbar'}? Samling runt ${time || 'utsatt tid'}.`],
                        'Bio': [`Biokväll! Vi ser "${title || 'den nya filmen'}" på ${location || 'biografen'}. Samling utanför en stund innan filmen börjar vid ${time || 'utsatt tid'}.`],
                        'Museum / Utställning': [`Nyfiken på lite kultur? Vi går på museum och kollar in ${title || 'en intressant utställning'} på ${location || 'museet'}. Start runt ${time || 'utsatt tid'}.`],
                        'Konsert / Gig': [`Livemusik! Vi går och ser ${title || 'ett grymt band'} på ${location || 'scenen'}. Häng på för en oförglömlig kväll! Starttid ${time || 'utsatt tid'}.`],
                        'Brädspel / Spelkväll': [`Dags för spelkväll! Vi samlas hemma hos mig eller på ${location || 'ett spelcafé'} för lite brädspel och trevligt umgänge. Start ${time || 'utsatt tid'}.`],
                        'Fotografering': [`Sugen på att fota? Vi tar en fotopromenad runt ${location || 'ett vackert område'} och fångar dagen på bild. Vi börjar vid ${time || 'utsatt tid'}.`],
                        'Annat': [`En avslappnad träff: ${title || ''}. Vi träffas vid ${location || 'utsatt plats'} runt ${time || 'starttid'}. Hoppas vi ses!`]
                    };
                    const categoryTemplates = templates[category] || templates['Annat'];
                    const randomIndex = Math.floor(Math.random() * categoryTemplates.length);
                    setDescription(categoryTemplates[randomIndex]);
                    setIsGenerating(false);
                }, 1000);
            };
            
            const handleSubmit = (e) => {
                e.preventDefault();
                const dateTime = combineDateAndTime(date, time);
                if (!dateTime) {
                    console.error("Date and time must be set.");
                    return;
                }
                const newEvent = {
                    eventID: Date.now(), title, description, category, location, dateTime, creatorUserID: currentUser.userID, attendeeUserIDs: [currentUser.userID]
                };
                onCreate(newEvent);
            };
            
            return (
                <div className="flex flex-col h-full bg-white">
                    <header className="p-4 flex items-center justify-between border-b border-slate-200/50 bg-white/50 backdrop-blur-sm sticky top-0">
                        <button onClick={() => onNavigate('home')} className="p-2 rounded-full hover:bg-slate-100/60">
                             <Icons.arrowLeft className="w-6 h-6 text-[#2E2E2E]" />
                        </button>
                        <h1 className="text-xl font-semibold text-[#C3B37A]">Skapa ny träff</h1>
                        <div className="w-10"></div>
                    </header>
                    <main className="flex-grow overflow-y-auto p-6">
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="text-sm font-bold text-[#2E2E2E]">Titel</label>
                                <input type="text" value={title} onChange={e => setTitle(e.target.value)} required className="w-full mt-1 p-2 border border-slate-200/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#C3B37A] bg-white" maxLength="29" />
                            </div>
                            <div>
                                <label className="text-sm font-bold text-[#2E2E2E]">Kategori</label>
                                <select value={category} onChange={e => setCategory(e.target.value)} className="w-full mt-1 p-2 border border-slate-200/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#C3B37A] bg-white">
                                    <optgroup label="☕ Mat & Dryck">
                                        <option>Fika</option>
                                        <option>Äta ute</option>
                                        <option>Ta ett glas</option>
                                    </optgroup>
                                    <optgroup label="🌳 Aktivitet & Natur">
                                        <option>Promenad</option>
                                        <option>Träna tillsammans</option>
                                        <option>Sport</option>
                                    </optgroup>
                                    <optgroup label="🎭 Kultur & Nöje">
                                        <option>Bio</option>
                                        <option>Museum / Utställning</option>
                                        <option>Konsert / Gig</option>
                                    </optgroup>
                                    <optgroup label="🎲 Hobby & Spel">
                                        <option>Brädspel / Spelkväll</option>
                                        <option>Fotografering</option>
                                    </optgroup>
                                    <optgroup label="✨ Annat">
                                        <option>Annat</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div>
                                <label className="text-sm font-bold text-[#2E2E2E]">Plats</label>
                                <input type="text" value={location} onChange={(e) => setLocation(e.target.value)} required className="w-full mt-1 p-2 border border-slate-200/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#C3B37A] bg-white" maxLength="70" />
                            </div>
                            <div className="flex gap-4">
                                <div className="flex-1">
                                    <label className="text-sm font-bold text-[#2E2E2E]">Datum</label>
                                    <div className="relative mt-1">
                                        <input type="date" value={date} min={today} onChange={e => setDate(e.target.value)} required className="w-full p-2 pr-10 border border-slate-200/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#C3B37A] bg-white" />
                                        <div className="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"><Icons.calendar className="w-5 h-5 text-slate-400" /></div>
                                    </div>
                                </div>
                                <div className="flex-1">
                                    <label className="text-sm font-bold text-[#2E2E2E]">Tid</label>
                                     <div className="relative mt-1">
                                        <input type="time" step="900" value={time} onChange={e => setTime(e.target.value)} required className="w-full p-2 pr-10 border border-slate-200/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#C3B37A] bg-white" />
                                         <div className="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"><Icons.clock className="w-5 h-5 text-slate-400" /></div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div className="flex justify-between items-center">
                                    <label className="text-sm font-bold text-[#2E2E2E]">Beskrivning</label>
                                    <button type="button" onClick={generateAIDescription} disabled={isGenerating} className="text-sm text-[#C3B37A] hover:underline font-semibold disabled:opacity-50">{isGenerating ? 'Genererar...' : 'Generera med AI'}</button>
                                </div>
                                <textarea value={description} onChange={e => setDescription(e.target.value)} required rows="4" className="w-full mt-1 p-2 border border-slate-200/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#C3B37A] bg-white" maxLength="280"></textarea>
                            </div>
                            <div className="pt-2"><ActionButton type="submit">Skapa träff</ActionButton></div>
                        </form>
                    </main>
                </div>
            );
        });
        
         const EditEventScreen = memo(({ eventId, events, onUpdate, onDelete, onNavigate }) => {
            const eventToEdit = useMemo(() => events.find(e => e.eventID === eventId), [events, eventId]);

            const [title, setTitle] = useState('');
            const [category, setCategory] = useState('Fika');
            const [location, setLocation] = useState('');
            const [date, setDate] = useState('');
            const [time, setTime] = useState('');
            const [description, setDescription] = useState('');
            const [isConfirmingDelete, setIsConfirmingDelete] = useState(false);
            
            useEffect(() => {
                if (eventToEdit) {
                    const eventDate = new Date(eventToEdit.dateTime);
                    setTitle(eventToEdit.title);
                    setCategory(eventToEdit.category);
                    setLocation(eventToEdit.location);
                    setDescription(eventToEdit.description);
                    setDate(eventDate.toISOString().split('T')[0]);
                    setTime(eventDate.toTimeString().substring(0, 5));
                }
            }, [eventToEdit]);


            if (!eventToEdit) {
                return <div className="p-4">Kunde inte hitta träffen att redigera.</div>;
            }

            const handleSubmit = (e) => {
                e.preventDefault();
                const dateTime = combineDateAndTime(date, time);
                if (!dateTime) {
                    console.error("Date and time must be set.");
                    return;
                }
                const updatedEvent = {
                    ...eventToEdit,
                    title, description, category, location, dateTime
                };
                onUpdate(updatedEvent);
            };

            const handleDelete = () => {
                onDelete(eventId);
            };

            return (
                <div className="flex flex-col h-full bg-white">
                    <header className="p-4 flex items-center justify-between border-b border-slate-200/50 bg-white/50 backdrop-blur-sm sticky top-0">
                        <button onClick={() => onNavigate('details', eventId)} className="p-2 rounded-full hover:bg-slate-100/60">
                             <Icons.arrowLeft className="w-6 h-6 text-[#2E2E2E]" />
                        </button>
                        <h1 className="text-xl font-semibold text-[#C3B37A]">Redigera träff</h1>
                        <div className="w-10"></div>
                    </header>
                    <main className="flex-grow overflow-y-auto p-6">
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="text-sm font-bold text-[#2E2E2E]">Titel</label>
                                <input type="text" value={title} onChange={e => setTitle(e.target.value)} required className="w-full mt-1 p-2 border border-slate-200/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#C3B37A] bg-white" maxLength="29" />
                            </div>
                            <div>
                                <label className="text-sm font-bold text-[#2E2E2E]">Kategori</label>
                                <select value={category} onChange={e => setCategory(e.target.value)} className="w-full mt-1 p-2 border border-slate-200/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#C3B37A] bg-white">
                                    <optgroup label="☕ Mat & Dryck">
                                        <option>Fika</option>
                                        <option>Äta ute</option>
                                        <option>Ta ett glas</option>
                                    </optgroup>
                                    <optgroup label="🌳 Aktivitet & Natur">
                                        <option>Promenad</option>
                                        <option>Träna tillsammans</option>
                                        <option>Sport</option>
                                    </optgroup>
                                    <optgroup label="🎭 Kultur & Nöje">
                                        <option>Bio</option>
                                        <option>Museum / Utställning</option>
                                        <option>Konsert / Gig</option>
                                    </optgroup>
                                    <optgroup label="🎲 Hobby & Spel">
                                        <option>Brädspel / Spelkväll</option>
                                        <option>Fotografering</option>
                                    </optgroup>
                                    <optgroup label="✨ Annat">
                                        <option>Annat</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div>
                                <label className="text-sm font-bold text-[#2E2E2E]">Plats</label>
                                <input type="text" value={location} onChange={(e) => setLocation(e.target.value)} required className="w-full mt-1 p-2 border border-slate-200/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#C3B37A] bg-white" maxLength="70" />
                            </div>
                            <div className="flex gap-4">
                                <div className="flex-1">
                                    <label className="text-sm font-bold text-[#2E2E2E]">Datum</label>
                                    <div className="relative mt-1">
                                        <input type="date" value={date} min={new Date().toISOString().split('T')[0]} onChange={e => setDate(e.target.value)} required className="w-full p-2 pr-10 border border-slate-200/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#C3B37A] bg-white" />
                                        <div className="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"><Icons.calendar className="w-5 h-5 text-slate-400" /></div>
                                    </div>
                                </div>
                                <div className="flex-1">
                                    <label className="text-sm font-bold text-[#2E2E2E]">Tid</label>
                                     <div className="relative mt-1">
                                        <input type="time" step="900" value={time} onChange={e => setTime(e.target.value)} required className="w-full p-2 pr-10 border border-slate-200/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#C3B37A] bg-white" />
                                         <div className="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none"><Icons.clock className="w-5 h-5 text-slate-400" /></div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label className="text-sm font-bold text-[#2E2E2E]">Beskrivning</label>
                                <textarea value={description} onChange={e => setDescription(e.target.value)} required rows="4" className="w-full mt-1 p-2 border border-slate-200/80 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#C3B37A] bg-white" maxLength="280"></textarea>
                            </div>
                            <div className="pt-4 space-y-2">
                                <ActionButton type="submit">Spara ändringar</ActionButton>
                                {isConfirmingDelete ? (
                                    <div className="text-center p-4 rounded-lg bg-red-50">
                                        <p className="font-semibold text-red-700">Är du säker på att du vill ta bort träffen?</p>
                                        <p className="text-sm text-slate-500">Detta kan inte ångras.</p>
                                        <div className="mt-4 flex gap-4">
                                            <button onClick={() => setIsConfirmingDelete(false)} className="flex-1 text-slate-600 font-semibold py-2 px-4 rounded-full bg-slate-200 hover:bg-slate-300 transition-colors">Avbryt</button>
                                            <button onClick={handleDelete} className="flex-1 text-white font-semibold py-2 px-4 rounded-full bg-red-600 hover:bg-red-700 transition-colors">Ja, ta bort</button>
                                        </div>
                                    </div>
                                ) : (
                                    <button onClick={() => setIsConfirmingDelete(true)} className="w-full text-red-600 font-semibold py-3 px-4 rounded-full bg-red-100 hover:bg-red-200 transition-colors flex items-center justify-center gap-2">
                                        <Icons.trash className="w-5 h-5" />
                                        <span>Ta bort träff</span>
                                    </button>
                                )}
                            </div>
                        </form>
                    </main>
                </div>
            );
        });

        const MyEventsScreen = memo(({ events, currentUser, onNavigate }) => {
            
            const categorizedEvents = useMemo(() => {
                const now = new Date();
                const upcomingJoined = [];
                const pastJoined = [];
                const createdEvents = [];

                events.forEach(event => {
                    const eventDate = new Date(event.dateTime);
                    const isAttending = event.attendeeUserIDs.includes(currentUser.userID);
                    const isCreator = event.creatorUserID === currentUser.userID;

                    if (isCreator) {
                        createdEvents.push(event);
                    }
                    if (isAttending) {
                        if (eventDate >= now) {
                           if(!isCreator) upcomingJoined.push(event);
                        } else {
                            pastJoined.push(event);
                        }
                    }
                });
                
                upcomingJoined.sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));
                pastJoined.sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime));
                createdEvents.sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));
                
                return { upcomingJoined, pastJoined, createdEvents };

            }, [events, currentUser.userID]);


            const EventCard = memo(({event, onNavigate, currentUser}) => {
                const isJoined = event.attendeeUserIDs.includes(currentUser.userID);
                const isCreator = event.creatorUserID === currentUser.userID;
                const borderColor = isCreator ? 'border-blue-400' : isJoined ? 'border-green-500' : 'border-[#5C524F]';
                
                return (
                     <div onClick={() => onNavigate('details', event.eventID)} className={`p-4 rounded-xl shadow-sm cursor-pointer transition-all bg-white hover:shadow-md relative border-[1mm] ${borderColor}`}>
                        <div className="flex items-start gap-4">
                            <div className="flex-1 min-w-0">
                                <p className="font-bold text-[#2E2E2E] truncate">{event.title}</p>
                                <p className="text-sm text-gray-600">{event.category}</p>
                                <div className="text-xs text-gray-500 mt-2 flex items-center gap-2">
                                    <Icons.clock className="w-3 h-3" />
                                    <span className="font-bold">{formatDateTime(event.dateTime)}</span>
                                </div>
                                <div className="text-xs text-gray-500 mt-1 flex items-center gap-2">
                                    <Icons.mapPin className="w-3 h-3" />
                                    <span className="truncate">{event.location}</span>
                                </div>
                            </div>
                            <div className="flex items-center text-sm text-blue-600 font-semibold">
                                <Icons.users className="w-4 h-4 mr-1" />
                                <span>{event.attendeeUserIDs.length}</span>
                            </div>
                        </div>
                        
                    </div>
                );
            });
            
            const EmptyState = ({icon, title, text}) => (
                <div className="text-center py-12">
                    <div className="w-16 h-16 mx-auto bg-slate-100 rounded-full flex items-center justify-center">{React.createElement(icon, { className: "w-8 h-8 text-slate-400" })}</div>
                    <h3 className="mt-4 text-lg font-semibold text-[#2E2E2E]">{title}</h3>
                    <p className="mt-1 text-sm text-[#2E2E2E]/70">{text}</p>
                </div>
            );
            
            return (
                <div className="flex flex-col h-full bg-white">
                    <header className="p-6 border-b border-slate-200/50 bg-white/80 backdrop-blur-sm sticky top-0 z-10"><h1 className="text-3xl font-bold text-[#C3B37A]">Mina träffar</h1></header>
                    <main className="flex-grow overflow-y-auto p-6 space-y-8">
                         <div>
                            <h2 className="text-lg font-bold text-[#2E2E2E] mb-3">På gång för mig ({categorizedEvents.upcomingJoined.length})</h2>
                            {categorizedEvents.upcomingJoined.length > 0 ? (
                                <div className="space-y-4">{categorizedEvents.upcomingJoined.map(event => (<EventCard key={event.eventID} event={event} onNavigate={onNavigate} currentUser={currentUser} />))}</div>
                            ) : (<EmptyState icon={Icons.calendar} title="Inga kommande träffar" text="Gå med i en träff för att se den här." />)}
                        </div>
                         <div>
                            <h2 className="text-lg font-bold text-[#2E2E2E] mb-3">Mina skapade träffar ({categorizedEvents.createdEvents.length})</h2>
                            {categorizedEvents.createdEvents.length > 0 ? (
                                <div className="space-y-4">{categorizedEvents.createdEvents.map(event => (<EventCard key={event.eventID} event={event} onNavigate={onNavigate} currentUser={currentUser} />))}</div>
                            ) : (<EmptyState icon={Icons.plus} title="Du har inte skapat något" text="Klicka på plus-knappen för att skapa din första träff." />)}
                        </div>
                         {categorizedEvents.pastJoined.length > 0 && (
                            <div>
                                <h2 className="text-lg font-bold text-[#2E2E2E] mb-3">Tidigare träffar ({categorizedEvents.pastJoined.length})</h2>
                                <div className="space-y-4 opacity-60">
                                    {categorizedEvents.pastJoined.map(event => (<EventCard key={event.eventID} event={event} onNavigate={onNavigate} currentUser={currentUser} />))}
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        });

        const ProfileScreen = memo(({ currentUser, onLogout, events, onNavigate }) => {
            const stats = useMemo(() => {
                return events.reduce((acc, event) => {
                    if (event.creatorUserID === currentUser.userID) {
                        acc.createdCount++;
                    }
                    if (event.attendeeUserIDs.includes(currentUser.userID) && event.creatorUserID !== currentUser.userID) {
                        acc.attendedCount++;
                    }
                    return acc;
                }, { createdCount: 0, attendedCount: 0});
            }, [events, currentUser.userID]);


            const SettingItem = ({ icon, label, onClick }) => (
                 <button onClick={onClick} className="w-full flex items-center justify-between text-left p-4 bg-white rounded-lg hover:bg-slate-100/60 transition-colors border border-slate-200/60">
                    <div className="flex items-center gap-4">
                        {React.createElement(icon, { className: "w-6 h-6 text-[#C3B37A]" })}
                        <span className="font-semibold text-[#2E2E2E]">{label}</span>
                    </div>
                    <Icons.chevronRight className="w-5 h-5 text-slate-400" />
                </button>
            );

            return (
                <div className="flex flex-col h-full bg-slate-50">
                    <header className="p-6 bg-white border-b border-slate-200/50">
                        <h1 className="text-3xl font-bold text-[#C3B37A]">Profil</h1>
                    </header>
                    <main className="flex-grow overflow-y-auto p-6 space-y-8">
                        <section className="flex flex-col items-center text-center space-y-2">
                             <div className="w-24 h-24 rounded-full bg-[#F5F5DC] flex items-center justify-center text-4xl font-bold text-[#2E2E2E] ring-4 ring-white/50 shadow-sm">{currentUser.name.charAt(0)}</div>
                             <h2 className="text-2xl font-bold text-[#2E2E2E] pt-2">{currentUser.name}</h2>
                             <p className="text-[#2E2E2E]/80">{currentUser.email}</p>
                        </section>

                        <section className="grid grid-cols-2 gap-4 text-center">
                            <div className="bg-white p-4 rounded-lg border border-slate-200/60">
                                <p className="text-2xl font-bold text-[#C3B37A]">{stats.createdCount}</p>
                                <p className="text-sm text-[#2E2E2E]/80">skapade</p>
                            </div>
                            <div className="bg-white p-4 rounded-lg border border-slate-200/60">
                                <p className="text-2xl font-bold text-[#C3B37A]">{stats.attendedCount}</p>
                                <p className="text-sm text-[#2E2E2E]/80">deltagna</p>
                            </div>
                        </section>

                        <section className="space-y-3">
                            <h3 className="px-1 text-sm font-semibold text-slate-500 uppercase tracking-wider">Inställningar</h3>
                            <div className="space-y-2">
                                <SettingItem icon={Icons.calendar} label="Min eventhistorik" onClick={() => onNavigate('event-history')} />
                                <SettingItem icon={Icons.user} label="Redigera profil" onClick={() => {}} />
                                <SettingItem icon={Icons.settings} label="Inställningar" onClick={() => {}} />
                            </div>
                        </section>
                        
                        <section>
                             <button onClick={onLogout} className="w-full flex items-center justify-center gap-2 px-5 py-3 text-sm font-semibold text-red-600 bg-white rounded-lg hover:bg-red-50 transition-colors border border-slate-200/60">
                                <Icons.logOut className="w-5 h-5" />
                                <span>Logga ut</span>
                            </button>
                        </section>
                    </main>
                </div>
            )
        });

        const EventHistoryScreen = memo(({ events, currentUser, usersById, onNavigate }) => {
            const historyStats = useMemo(() => {
                const now = new Date();
                const pastAttendedEvents = events.filter(e => 
                    new Date(e.dateTime) < now && 
                    e.attendeeUserIDs.includes(currentUser.userID)
                );

                if (pastAttendedEvents.length === 0) {
                    return { pastAttendedEvents, total: 0, topCategory: 'Ingen än', topCompanion: 'Ingen än' };
                }

                const categoryCounts = pastAttendedEvents.reduce((acc, event) => {
                    acc[event.category] = (acc[event.category] || 0) + 1;
                    return acc;
                }, {});

                const topCategory = Object.keys(categoryCounts).reduce((a, b) => categoryCounts[a] > categoryCounts[b] ? a : b);

                const companionCounts = pastAttendedEvents
                    .flatMap(event => event.attendeeUserIDs)
                    .filter(id => id !== currentUser.userID)
                    .reduce((acc, id) => {
                        acc[id] = (acc[id] || 0) + 1;
                        return acc;
                    }, {});

                const topCompanionId = Object.keys(companionCounts).reduce((a, b) => companionCounts[a] > companionCounts[b] ? a : b, null);
                const topCompanion = topCompanionId ? usersById[topCompanionId]?.name : 'Ingen än';

                return {
                    pastAttendedEvents: pastAttendedEvents.sort((a, b) => new Date(b.dateTime) - new Date(a.dateTime)),
                    total: pastAttendedEvents.length,
                    topCategory,
                    topCompanion
                };
            }, [events, currentUser.userID, usersById]);

            const StatCard = ({ label, value }) => (
                <div className="bg-white p-4 rounded-lg border border-slate-200/60 text-center">
                    <p className="text-sm text-[#2E2E2E]/80">{label}</p>
                    <p className="text-xl font-bold text-[#C3B37A]">{value}</p>
                </div>
            );

            return (
                <div className="flex flex-col h-full bg-slate-50">
                    <header className="p-4 flex items-center gap-4 border-b border-slate-200/50 bg-white/80 backdrop-blur-sm sticky top-0 z-10">
                        <button onClick={() => onNavigate('profile')} className="p-2 rounded-full hover:bg-slate-100/60">
                            <Icons.arrowLeft className="w-6 h-6 text-[#2E2E2E]" />
                        </button>
                        <h1 className="text-xl font-semibold text-[#C3B37A]">Min Eventhistorik</h1>
                    </header>
                    <main className="flex-grow overflow-y-auto p-6 space-y-8">
                        <section>
                            <h2 className="text-lg font-bold text-[#2E2E2E] mb-3">Din resa hittills</h2>
                            <div className="grid grid-cols-3 gap-4">
                                <StatCard label="Träffar" value={historyStats.total} />
                                <StatCard label="Favorit" value={historyStats.topCategory} />
                                <StatCard label="Bästis" value={historyStats.topCompanion} />
                            </div>
                        </section>
                        
                        <section>
                             <h2 className="text-lg font-bold text-[#2E2E2E] mb-3">Tidslinje</h2>
                             {historyStats.pastAttendedEvents.length > 0 ? (
                                <div className="space-y-3">
                                    {historyStats.pastAttendedEvents.map(event => (
                                        <div key={event.eventID} className="bg-white p-3 rounded-lg border border-slate-200/60 flex items-center gap-4">
                                            <div className="w-10 h-10 bg-slate-100 rounded-lg flex items-center justify-center">
                                                <Icons.calendar className="w-5 h-5 text-slate-500" />
                                            </div>
                                            <div>
                                                <p className="font-semibold text-[#2E2E2E]">{event.title}</p>
                                                <p className="text-sm text-slate-500">{formatDateTime(event.dateTime)}</p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                             ) : (
                                <div className="text-center py-10">
                                    <p className="text-slate-500">Du har inte deltagit i några träffar än.</p>
                                </div>
                             )}
                        </section>
                    </main>
                </div>
            );
        });

        const Toast = ({ message, show }) => {
            if (!show) return null;
            return (<div className="fixed bottom-24 left-1/2 -translate-x-1/2 bg-[#3D3D3D] text-white px-4 py-2 rounded-full text-sm shadow-lg animate-fade-in-out">{message}</div>);
        };

        const ChatListScreen = memo(({ events, currentUser, onNavigate, chatMessages, onSendMessage, usersById }) => {
            const [expandedChatId, setExpandedChatId] = useState(null);
            const joinedEvents = useMemo(() => events
                .filter(e => e.attendeeUserIDs.includes(currentUser.userID))
                .sort((a,b) => new Date(b.dateTime) - new Date(a.dateTime)), [events, currentUser.userID]);

            const handleToggleChat = (eventId) => {
                setExpandedChatId(prevId => prevId === eventId ? null : eventId);
            };

            const EmptyState = () => (
                <div className="text-center py-12">
                    <div className="w-16 h-16 mx-auto bg-slate-100 rounded-full flex items-center justify-center">
                        <Icons.messageCircle className="w-8 h-8 text-slate-400" />
                    </div>
                    <h3 className="mt-4 text-lg font-semibold text-[#2E2E2E]">Inga chattar än</h3>
                    <p className="mt-1 text-sm text-[#2E2E2E]/70">Gå med i en träff för att börja chatta.</p>
                </div>
            );

            return (
                <div className="flex flex-col h-full bg-white">
                    <header className="p-6 border-b border-slate-200/50 bg-white/80 backdrop-blur-sm sticky top-0 z-10">
                        <h1 className="text-3xl font-bold text-[#C3B37A]">Chattar</h1>
                    </header>
                    <main className="flex-grow overflow-y-auto p-6 space-y-4">
                        {joinedEvents.length > 0 ? (
                            joinedEvents.map(event => {
                                const isCreator = event.creatorUserID === currentUser.userID;
                                const borderColor = isCreator ? 'border-blue-400' : 'border-green-500';
                                const attendees = event.attendeeUserIDs.map(id => usersById[id]);
                                return (
                                    <div key={event.eventID} className={`bg-white rounded-lg shadow-sm transition-all border-[1mm] ${borderColor}`}>
                                        <div onClick={() => handleToggleChat(event.eventID)} className="p-4 cursor-pointer hover:bg-slate-100/60 relative">
                                            <div className="flex items-start gap-4">
                                                <div className="flex-1 min-w-0">
                                                    <p className="font-bold text-[#2E2E2E] truncate">{event.title}</p>
                                                    <p className="text-sm text-[#2E2E2E]">{event.category}</p>
                                                    <div className="text-xs text-[#2E2E2E]/80 mt-2 flex items-center gap-2">
                                                        <Icons.clock className="w-3 h-3" />
                                                        <span className="font-bold">{formatDateTime(event.dateTime)}</span>
                                                    </div>
                                                    <div className="text-xs text-[#2E2E2E]/80 mt-1 flex items-center gap-2">
                                                        <Icons.mapPin className="w-3 h-3" />
                                                        <span className="truncate">{event.location}</span>
                                                    </div>
                                                </div>
                                                <div className="flex items-center text-sm text-blue-600 font-semibold">
                                                    <Icons.users className="w-4 h-4 mr-1" />
                                                    <span>{event.attendeeUserIDs.length}</span>
                                                </div>
                                            </div>
                                            <div className="mt-3 pt-3 border-t border-slate-200/60">
                                                 <h4 className="text-sm font-semibold text-slate-600 mb-2">Deltagare</h4>
                                                 <div className="flex flex-wrap gap-2">
                                                    {attendees.map(attendee => attendee && (
                                                        <div key={attendee.userID} className={`flex items-center gap-2 pr-3 py-1 bg-slate-100 text-[#2E2E2E] rounded-full text-sm`}>
                                                            <div className="w-6 h-6 rounded-full bg-[#F5F5DC] flex items-center justify-center font-bold text-[#2E2E2E]/70 text-xs">
                                                                {attendee.name.charAt(0)}
                                                            </div>
                                                            {attendee.name}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                        {expandedChatId === event.eventID && (
                                            <div className="p-4 border-t border-slate-200/80">
                                                 <ChatComponent eventId={event.eventID} messages={chatMessages[event.eventID] || []} usersById={usersById} currentUser={currentUser} onSendMessage={onSendMessage} hasJoined={true} isCreator={isCreator} />
                                            </div>
                                        )}
                                    </div>
                                );
                            })
                        ) : (
                            <EmptyState />
                        )}
                    </main>
                </div>
            );
        });
        
        function App() {
            const [currentUser, setCurrentUser] = useState(null);
            const [users, setUsers] = useState(USERS_DATA);
            const [events, setEvents] = useState(INITIAL_EVENTS_DATA);
            const [view, setView] = useState({ name: 'login', payload: null });
            const [chatMessages, setChatMessages] = useState(INITIAL_CHAT_MESSAGES_DATA);
            const [toast, setToast] = useState({ show: false, message: '' });

            const usersById = useMemo(() => 
                users.reduce((acc, user) => {
                    acc[user.userID] = user;
                    return acc;
                }, {}), 
            [users]);


            useEffect(() => {
                if (toast.show) {
                    const timer = setTimeout(() => {
                        setToast({ show: false, message: '' });
                    }, 3000);
                    return () => clearTimeout(timer);
                }
            }, [toast]);

            const showToast = (message) => {
                setToast({ show: true, message });
            };

            const handleLogin = (user) => {
                setCurrentUser(user);
                setView({ name: 'home', payload: null });
            };
            
            const handleLogout = () => {
                setCurrentUser(null);
               setView({ name: 'login', payload: null });
            };

            const handleNavigate = (viewName, payload = null) => {
                setView({ name: viewName, payload });
            };
            
            const handleCreateEvent = (newEvent) => {
                setEvents(prevEvents => [newEvent, ...prevEvents]);
                handleNavigate('home');
                showToast('Din träff har skapats!');
            };

             const handleUpdateEvent = (updatedEvent) => {
                setEvents(prevEvents => prevEvents.map(event => 
                    event.eventID === updatedEvent.eventID ? updatedEvent : event
                ));
                handleNavigate('details', updatedEvent.eventID);
                showToast('Träffen har uppdaterats!');
            };

            const handleDeleteEvent = (eventId) => {
                setEvents(prevEvents => prevEvents.filter(event => event.eventID !== eventId));
                handleNavigate('home');
                showToast('Träffen har tagits bort.');
            };

            
            const handleJoinEvent = (eventId) => {
                setEvents(prevEvents => prevEvents.map(event => {
                    if (event.eventID === eventId && !event.attendeeUserIDs.includes(currentUser.userID)) {
                        return { ...event, attendeeUserIDs: [...event.attendeeUserIDs, currentUser.userID] };
                    }
                    return event;
                }));
                showToast('Du är nu med i träffen!');
            };

            const handleLeaveEvent = (eventId) => {
                setEvents(prevEvents => prevEvents.map(event => {
                    if (event.eventID === eventId) {
                        return { ...event, attendeeUserIDs: event.attendeeUserIDs.filter(id => id !== currentUser.userID) };
                    }
                    return event;
                }));
                showToast('Du har lämnat träffen.');
            };

            const handleSignUp = (newUserData) => {
                const newUser = {
                    ...newUserData,
                    userID: Date.now(),
                };
                setUsers(prevUsers => [...prevUsers, newUser]);
                setCurrentUser(newUser);
               setView({ name: 'home', payload: null });
            };

            const handleSendMessage = (eventId, text) => {
                const newMessage = {
                    messageID: Date.now(),
                    userID: currentUser.userID,
                    text: text,
                    timestamp: new Date().toISOString()
                };
                setChatMessages(prevMessages => ({
                    ...prevMessages,
                    [eventId]: [...(prevMessages[eventId] || []), newMessage]
                }));
            };

            const renderView = () => {
                if (!currentUser) {
                    switch(view.name) {
                        case 'signup':
                            return <SignUpScreen onSignUp={handleSignUp} onNavigate={handleNavigate} />;
                        default:
                            return <LoginScreen users={users} onLogin={handleLogin} onNavigate={handleNavigate} />;
                    }
                }
                
                let mainContent;
                switch (view.name) {
                    case 'details':
                        mainContent = <EventDetailsScreen 
                            eventId={view.payload} 
                            events={events} 
                            usersById={usersById} 
                            currentUser={currentUser} 
                            onJoin={handleJoinEvent} 
                            onLeave={handleLeaveEvent}
                            onNavigate={handleNavigate}
                            chatMessages={chatMessages}
                            onSendMessage={handleSendMessage}
                        />;
                        break;
                    case 'create':
                        mainContent = <CreateEventScreen currentUser={currentUser} onCreate={handleCreateEvent} onNavigate={handleNavigate} />;
                        break;
                    case 'edit-event':
                        mainContent = <EditEventScreen 
                            eventId={view.payload}
                            events={events}
                            onUpdate={handleUpdateEvent}
                            onDelete={handleDeleteEvent}
                            onNavigate={handleNavigate}
                        />;
                        break;
                    case 'my-events':
                        mainContent = <MyEventsScreen events={events} currentUser={currentUser} onNavigate={handleNavigate} />;
                        break;
                    case 'chat':
                        mainContent = <ChatListScreen events={events} currentUser={currentUser} onNavigate={handleNavigate} chatMessages={chatMessages} onSendMessage={handleSendMessage} usersById={usersById} />;
                        break;
                    case 'profile':
                        mainContent = <ProfileScreen events={events} currentUser={currentUser} onLogout={handleLogout} onNavigate={handleNavigate} />;
                        break;
                    case 'event-history':
                        mainContent = <EventHistoryScreen events={events} currentUser={currentUser} usersById={usersById} onNavigate={handleNavigate} />;
                        break;
                    default:
                        mainContent = <HomeScreen events={events} onNavigate={handleNavigate} currentUser={currentUser} />;
                }

                const showBottomNav = ['home', 'my-events', 'chat', 'profile', 'create', 'details', 'edit-event'].includes(view.name);
                
                return (
                    <div className="h-full flex flex-col relative">
                        <div className="flex-grow overflow-y-auto" style={{ height: '100vh' }}>
                            {mainContent}
                        </div>
                        {['home', 'my-events'].includes(view.name) && (
                                <button 
                                 onClick={() => handleNavigate('create')} 
                                 className="absolute bottom-24 right-6 w-14 h-14 rounded-full bg-[#C3B37A] text-white shadow-lg flex items-center justify-center hover:opacity-90 transition-opacity"
                            >
                                <Icons.plus className="w-8 h-8" />
                            </button>
                        )}
                        {showBottomNav && <BottomNav activeView={view.name} onNavigate={handleNavigate} />}
                    </div>
                );
            };

            return (
                <div className="bg-slate-100 min-h-screen flex justify-center">
                    <div className="w-full max-w-sm bg-white shadow-lg flex flex-col" style={{ height: '100vh', maxHeight: '100vh', overflow: 'hidden' }}>
                        {renderView()}
                    </div>
                     <Toast message={toast.message} show={toast.show} />
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>






